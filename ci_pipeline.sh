#!/bin/bash

# Проверка аргументов
if [ -z "$1" ]; then
    echo "Не введен первый параметр, отвечающий за путь до директории с проектом."
    exit 1
fi

project_dir=\$1
cd "$project_dir" || { echo "Ошибка: не удалось перейти в директорию $project_dir"; exit 1; }

# 1. Загрузка актуального состояния с сервера
echo "Загрузка актуального состояния с сервера..."
git pull origin master || { echo "Ошибка: не удалось загрузить изменения."; exit 1; }

# 2. Установка зависимостей
echo "Установка зависимостей..."
pip install -r requirements.txt || { echo "Ошибка: не удалось установить зависимости."; exit 1; }

# 3. Сборка проекта (в данном случае просто проверим, что можно запустить main.py)
echo "Сборка проекта..."
python3 main.py || { echo "Ошибка: не удалось собрать проект."; exit 1; }

# 4. Выполнение unit-тестов
echo "Выполнение unit-тестов..."
python3 -m unittest discover -s . -p "test.py" || { echo "Ошибка: тесты не прошли."; exit 1; }

# 5. Создание пакета установки
echo "Создание пакета установки..."
# Предполагается, что в корне проекта есть setup.py
python3 setup.py sdist bdist_wheel || { echo "Ошибка: не удалось создать пакет установки."; exit 1; }

# 6. Установка приложения
echo "Установка приложения..."
pip install dist/*.whl || { echo "Ошибка: не удалось установить приложение."; exit 1; }

echo "Процесс CI завершен успешно!"
